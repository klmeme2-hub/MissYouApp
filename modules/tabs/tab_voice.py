import streamlit as st
from modules import audio, database
import random

def render(supabase, client, user_id, target_role, tier):
    
    # å°èˆªåˆ—
    steps = {
        1: "1.å£é ­ç¦ª/æš±ç¨±",
        2: "2.å®‰æ…°èªæ°£",
        3: "3.é¼“å‹µèªæ°£",
        4: "4.è©¼è«§èªæ°£",
        5: "5.å®Œæˆ"
    }

    cols = st.columns([1.5, 1, 1, 1, 1, 3]) 
    for i in range(1, 6):
        btn_type = "primary" if st.session_state.step == i else "secondary"
        if cols[i-1].button(steps[i], key=f"nav_step_{i}", type=btn_type, use_container_width=True):
            st.session_state.step = i
            st.rerun()

    st.markdown("---")

    # è§’è‰²é¡¯ç¤ºè¨­å®š
    ROLE_DISPLAY_NAMES = {
        "friend": "æœ‹å‹/æ­»é»¨", "partner": "å¦»å­/ä¸ˆå¤«/ä¼´ä¾¶", "son": "å…’å­",
        "daughter": "å¥³å…’", "junior": "å…’å­/å¥³å…’/æ™šè¼©", "elder": "é•·è¼©/çˆ¶æ¯", "others": "è¦ªå‹"
    }
    role_zh = ROLE_DISPLAY_NAMES.get(target_role, target_role)

    # åˆå§‹åŒ–åŠ‡æœ¬ç´¢å¼•
    if "script_idx" not in st.session_state:
        st.session_state.script_idx = 0

    # ==========================================
    # åŠ‡æœ¬æ±  (Script Pool)
    # ==========================================
    SCRIPTS_POOL = {
        2: { # å®‰æ…°èªæ°£
            "title": "åˆ»éŒ„ã€Œå®‰æ…°èªæ°£ã€",
            "file": "tone_comfort",
            "contents": [
                "æ¬¸ï¼Œæˆ‘çŸ¥é“ä½ ç¾åœ¨å¿ƒè£¡ä¸€å®šè¶…æ‚¶çš„å•¦ï¼Œæ„Ÿè¦ºæ˜¯ä¸æ˜¯ä»˜å‡ºçš„å¿ƒè¡€éƒ½ç™½è²»äº†ï¼Ÿå¼ï¼Œæ²’é—œä¿‚å•¦ï¼ŒçœŸçš„æ²’é—œä¿‚ï¼Œè®“æˆ‘æŠ±ä¸€ä¸‹ã€‚ä½ çœ‹ä½ é½ï¼ŒæŠŠè‡ªå·±é€¼å¾—é‚£éº¼ç·Šï¼Œæ—©å°±ç´¯å£äº†ã€‚æˆ‘å€‘å…ˆæ‰¾å€‹åœ°æ–¹åä¸‹ä¾†ï¼Œå–æ¯ç†±çš„ï¼Œä¼‘æ¯ä¸€ä¸‹å¥½ä¸å¥½ï¼Ÿ",
                "ä¹–ï¼Œä¸è¦å“­äº†ï¼Œçœ‹ä½ é€™æ¨£æˆ‘ä¹Ÿå¥½é›£éã€‚é€™ä¸–ç•Œä¸Šæœ¬ä¾†å°±æœ‰å¾ˆå¤šäº‹æƒ…æ˜¯ä¸å…¬å¹³çš„ï¼Œä½ å·²ç¶“ç›¡åŠ›äº†ï¼Œå¤§å®¶éƒ½çœ‹åœ¨çœ¼è£¡ã€‚ä»Šå¤©æ™šä¸Šæˆ‘å€‘ä¸è«‡æ­£äº‹ï¼Œå¥½å¥½ç¡ä¸€è¦ºï¼Œæ˜å¤©å¤ªé™½å‡èµ·ä¾†ï¼Œåˆæ˜¯ä¸€æ¢å¥½æ¼¢ï¼Œå°ä¸å°ï¼Ÿ",
                "å…¶å¯¦ï¼Œå¤±æ•—çœŸçš„æ²’ä»€éº¼å¤§ä¸äº†çš„ã€‚æˆ‘ä»¥å‰ä¹Ÿæ‘”éå¾ˆé‡çš„ä¸€è·¤å•Šï¼Œé‚£æ™‚å€™è¦ºå¾—å¤©éƒ½è¦å¡Œä¸‹ä¾†äº†ã€‚ä½†ç¾åœ¨å›é ­çœ‹ï¼Œé‚£åªæ˜¯äººç”Ÿçš„ä¸€å€‹å°æ’æ›²è€Œå·²ã€‚ä½ ç¾åœ¨è¦ºå¾—éä¸å»çš„åï¼Œéå¹¾å¹´çœ‹ï¼Œéƒ½åªæ˜¯æ•…äº‹ã€‚æˆ‘æœƒä¸€ç›´é™ªè‘—ä½ çš„ã€‚",
                "åˆ¥æ°£é¤’å•¦ï¼Œé€™ç¨®é³¥äº‹èª°æ²’é‡éï¼Ÿé‡è¦çš„æ˜¯æˆ‘å€‘å¾è£¡é¢å­¸åˆ°äº†ä»€éº¼ã€‚ä½ æœ‰ä¸€é¡†å¾ˆå–„è‰¯ã€å¾ˆå …å¼·çš„å¿ƒï¼Œé€™æ‰æ˜¯æœ€çè²´çš„ã€‚ä¸è¦å› ç‚ºåˆ¥äººçš„å¹¾å¥è©±å°±å¦å®šè‡ªå·±ï¼Œä½ åœ¨æˆ‘å¿ƒä¸­æ°¸é æ˜¯æœ€æ£’çš„ã€‚",
                "å¥½å•¦å¥½å•¦ï¼Œæˆ‘çŸ¥é“ä½ å¾ˆå§”å±ˆã€‚ä¾†ï¼Œè‚©è†€å€Ÿä½ é ã€‚æœ‰æ™‚å€™äººç”Ÿå°±æ˜¯é€™æ¨£ï¼Œèµ·èµ·è½è½çš„å˜›ã€‚æˆ‘å€‘å»åƒé “å¥½åƒçš„ï¼ŒæŠŠé€™äº›ä¸é–‹å¿ƒçš„äº‹éƒ½åƒé€²è‚šå­è£¡æ¶ˆåŒ–æ‰ï¼Œç„¶å¾Œé‡æ–°å‡ºç™¼ï¼"
            ]
        },
        3: { # é¼“å‹µèªæ°£
            "title": "åˆ»éŒ„ã€Œé¼“å‹µèªæ°£ã€",
            "file": "tone_encourage",
            "contents": [
                "å“‡å¡ï¼ä½ çœŸçš„æ±ºå®šè¦é–‹å§‹å­¸é‚£å€‹æ±è¥¿äº†å–”ï¼Ÿè¶…é…·çš„å•¦ï¼æˆ‘çŸ¥é“ä¸€é–‹å§‹æœƒå¾ˆé›£ã€å¾ˆç…©ï¼Œé‚£ä»‹é¢çœ‹èµ·ä¾†åƒå¤–æ˜Ÿæ–‡ï¼Œæ²’éŒ¯å•¦ï¼ä½†ä½ æƒ³æƒ³çœ‹ï¼Œç­‰ä½ çœŸçš„å­¸æœƒäº†ï¼Œé‚£å€‹æˆå°±æ„Ÿæœƒæœ‰å¤šçˆ†ç‚¸ï¼Ÿè¡å•Šï¼æˆ‘ç­‰ä½ åšå‡ºç¬¬ä¸€å€‹æˆå“ï¼",
                "ä½ ä¸€å®šå¯ä»¥çš„å•¦ï¼æˆ‘çœ‹äººå¾ˆæº–çš„ã€‚ä½ èº«ä¸Šæœ‰ä¸€ç¨®åˆ¥äººæ²’æœ‰çš„æ¯…åŠ›ï¼Œåªè¦ä½ ä¸‹å®šæ±ºå¿ƒï¼Œæ²’æœ‰ä»€éº¼äº‹æƒ…æ˜¯åšä¸åˆ°çš„ã€‚ä¸è¦å®³æ€•æŒ‘æˆ°ï¼ŒæŒ‘æˆ°æ˜¯æˆé•·çš„é¤Šåˆ†ã€‚åŠ æ²¹ï¼Œæˆ‘çµ•å°æŒºä½ åˆ°åº•ï¼",
                "åˆ¥çŒ¶è±«äº†ï¼Œæ©Ÿæœƒæ˜¯ä¸ç­‰äººçš„ï¼ç¾åœ¨å°±æ˜¯æœ€å¥½çš„æ™‚æ©Ÿã€‚é›–ç„¶å‰é¢é€™æ¢è·¯çœ‹èµ·ä¾†æœ‰é»æš—ï¼Œä½†åªè¦ä½ è·¨å‡ºç¬¬ä¸€æ­¥ï¼Œè·¯å°±æœƒæ…¢æ…¢äº®èµ·ä¾†ã€‚ç›¸ä¿¡è‡ªå·±çš„ç›´è¦ºï¼Œå‹‡æ•¢åœ°å»é—–ä¸€é—–å§ï¼",
                "æˆ‘çœ‹å¥½ä½ å–”ï¼é€™è¨ˆç•«è½èµ·ä¾†è¶…æœ‰æé ­çš„ã€‚é›–ç„¶ç¾åœ¨é‚„åœ¨è‰å‰µæœŸï¼Œæœƒæ¯”è¼ƒè¾›è‹¦ä¸€é»ï¼Œä½†åªè¦æ’éå»ï¼Œæœå¯¦ä¸€å®šå¾ˆç”œç¾ã€‚è¨˜å¾—ï¼Œé‡åˆ°å›°é›£éš¨æ™‚ä¾†æ‰¾æˆ‘å•†é‡ï¼Œæˆ‘å€‘ä¸€èµ·æƒ³è¾¦æ³•è§£æ±ºï¼",
                "æŠŠé ­æŠ¬èµ·ä¾†ï¼é€™é»å°æŒ«æŠ˜ç®—ä»€éº¼ï¼Ÿä½ å¯æ˜¯æˆ‘çœ‹éæœ€æœ‰æ½›åŠ›çš„äººæ¬¸ï¼ä¸è¦è®“ä¸€æ™‚çš„å¤±æ•—æ“Šå€’ä½ ã€‚æ•´ç†ä¸€ä¸‹å¿ƒæƒ…ï¼Œé‡æ–°èª¿æ•´æ­¥ä¼ï¼Œå†ä¸€æ¬¡ï¼Œé€™æ¬¡ä½ ä¸€å®šæœƒæˆåŠŸçš„ï¼"
            ]
        },
        4: { # è©¼è«§èªæ°£
            "title": "åˆ»éŒ„ã€Œè¼•é¬†è©¼è«§èªæ°£ã€",
            "file": "tone_humor",
            "contents": [
                "æˆ‘è·Ÿä½ èªªï¼Œæˆ‘æ˜¨å¤©å»åœ–æ›¸é¤¨ K æ›¸ï¼ŒçœŸçš„ç³—æ­»äº†å•¦ï¼æˆ‘æŠŠæ°´å£ºæ”¾åœ¨æ¡Œä¸Šï¼Œæƒ³èªªè¦è£ä¸€ä¸‹æ–‡é’å°ä¸å°ï¼Ÿçµæœæˆ‘ä¸€å€‹ä¸å°å¿ƒï¼Œé‚£å€‹é‡‘å±¬æ°´å£ºç›´æ¥æ»¾åˆ°åœ°ä¸Šï¼Œç™¼å‡ºé‚£ç¨®ã€ŒåŒ¡å•·åŒ¡å•·ã€è¶…å¤§è²çš„è²éŸ³ï¼å…¨éƒ¨äººéƒ½çœ‹æˆ‘ï¼Œæˆ‘åªå¥½å‡è£ç¡è‘—ï¼",
                "æ¬¸ä½ çŸ¥é“å—ï¼Ÿæˆ‘æ˜¨å¤©å»è²·é¹½é…¥é›ï¼Œè€é—†å•æˆ‘è¦ä¸è¦è¾£ï¼Œæˆ‘èªªå¾®è¾£ã€‚çµæœå›å®¶ä¸€åƒï¼Œé‚£æ˜¯åœ°ç„è¾£å§ï¼æˆ‘åƒåˆ°å˜´å·´éƒ½è…«æˆé¦™è…¸å˜´ï¼Œçœ¼æ·šé¼»æ¶•ç›´æµï¼Œé‚„è¦ä¸€é‚Šå–å†°æ°´ä¸€é‚Šåƒï¼ŒçœŸçš„æœ‰å¤ è‡ªè™çš„å•¦ï¼",
                "å¼ï¼Œæˆ‘å®¶é‚£éš»è²“çœŸçš„å¾ˆæ©Ÿè»Šæ¬¸ã€‚æˆ‘æ˜¨å¤©å‰›è²·ä¸€å€‹è¶…è²´çš„è²“çª©çµ¦å®ƒï¼Œçµæœå®ƒçœ‹éƒ½ä¸çœ‹ä¸€çœ¼ï¼Œç›´æ¥è·³é€²è£è²“çª©çš„é‚£å€‹ç ´ç´™ç®±è£¡ç¡è¦ºï¼æˆ‘çœŸçš„æ˜¯èŠ±éŒ¢è²·å¯‚å¯æ¬¸ï¼Œæ—©çŸ¥é“æˆ‘å°±çµ¦å®ƒç´™ç®±å°±å¥½äº†å˜›ï¼",
                "è·Ÿä½ è¬›ä¸€ä»¶è¶…ç™½ç—´çš„äº‹ã€‚æˆ‘æ—©ä¸Šå‡ºé–€å¤ªè¶•ï¼Œç©¿äº†ä¸€é»‘ä¸€ç™½çš„è¥ªå­å»ä¸Šç­ï¼Œé‡é»æ˜¯æˆ‘åˆ°ä¸­åˆåƒé£¯è„«é‹å­æ‰ç™¼ç¾ï¼åŒäº‹é‚„å•æˆ‘æ˜¯ä¸æ˜¯é€™å­£æœ€æ–°çš„æµè¡Œç©¿æ­ï¼Œæˆ‘åªå¥½ç¡¬è‘—é ­çš®èªªæ˜¯ï¼Œç¬‘æ­»æˆ‘äº†ï¼",
                "æ˜¨å¤©æˆ‘å»å¥èº«æˆ¿æƒ³èªªè¦ç·´ä¸€ä¸‹è…¹è‚Œï¼Œçµæœåšä»°è‡¥èµ·åçš„æ™‚å€™ï¼Œæ”¾äº†ä¸€å€‹è¶…å¤§è²çš„å±ï¼æ—é‚Šé‚£å€‹æ•™ç·´é‚„å‡è£æ²’è½åˆ°ï¼Œç¹¼çºŒæ•¸ã€Œäº”ã€å…­ã€ä¸ƒ...ã€ï¼Œæˆ‘è‡ªå·±éƒ½å°·å°¬åˆ°æƒ³æŒ–å€‹åœ°æ´é‘½é€²å»ï¼Œç·´å®Œé¦¬ä¸Šå…‰é€Ÿé€ƒè·‘ï¼"
            ]
        }
    }

    # ==========================================
    # STEP 1: æ ¸å¿ƒäººè¨­
    # ==========================================
    if st.session_state.step == 1:
        # (Step 1 é‚è¼¯ç¶­æŒä¸è®Š)
        if target_role == "friend":
            st.subheader("STEP 1: å£é ­ç¦ªç‚¸å½ˆ ğŸ’£")
            ai_demo_text = "ä½ è¦ºå¾—é€™å€‹AIåˆ†èº«ï¼Œè·Ÿæˆ‘æœ¬å°Šæœ‰å¹¾åˆ†åƒå‘¢ï¼Ÿ"
            id_label = "1. è¨­å®šèº«åˆ†"
            id_help = f"è«‹è¼¸å…¥ {role_zh} å¹³å¸¸ **æ€éº¼å«æ‚¨**ï¼Ÿ"
            id_placeholder = "ä¾‹å¦‚ï¼šé˜¿å¼·ã€æ±å“¥ã€å°å¨Ÿ"
            sound_label = "2. éŒ„è£½é–‹å ´ç™½"
            sound_desc = "ç•™ä¸€å¥è©±çµ¦æ›å¸–çš„æ‹œæŠŠå…„å¼Ÿï¼Œè®“ä»–æ¥èµ·é›»è©±å¯’æ¯›ç›´è±ã€‚"
            sound_hint = "ğŸ‘‰ **å»ºè­°éŒ„è£½ï¼š** ã€Œå‘·é£½æœªï¼Ÿã€ æˆ– ã€Œå¥½ä¹…ä¸è¦‹ï¼ï¼ã€ æˆ– æ‚¨çš„æ‹›ç‰Œå£é ­ç¦ª"
        else:
            st.subheader("STEP 1: è¼•è¼•å–šä½ çš„å â¤ï¸")
            ai_demo_text = "æƒ³æˆ‘å—ï¼Ÿ"
            id_label = "1. è¨­å®šèº«åˆ†"
            id_help = f"è«‹è¼¸å…¥ {role_zh} å¹³å¸¸ **æ€éº¼å«æ‚¨**ï¼Ÿ"
            id_placeholder = "ä¾‹å¦‚ï¼šè€å…¬ã€é»‘ç‹—çˆ¸ã€è€åª½"
            sound_label = "2. å®Œç¾æš±ç¨±ï¼šéŒ„è£½æœ€è‡ªç„¶è¦ªå¯†å‘¼å–š"
            sound_desc = "è«‹ç”¨æœ€æº«æŸ”ã€è‡ªç„¶çš„èªæ°£ï¼Œå‘¼å–šå°æ–¹çš„åå­—æˆ–å°åã€‚é€™æ®µè²éŸ³æœƒç”¨åœ¨æ¯æ¬¡å°è©±çš„é–‹é ­ã€‚"
            sound_hint = "ğŸ‘‰ **å»ºè­°éŒ„è£½ï¼š** ã€Œè€å©†ï½ã€ æˆ– ã€Œè¦ªæ„›çš„ï½ã€"

        st.markdown(f"##### {id_label}")
        st.caption(id_help)
        member_nick = st.text_input("èº«åˆ†", placeholder=id_placeholder, label_visibility="collapsed", key="s1_mn")
        st.markdown("") 
        st.markdown(f"##### {sound_label}")
        st.write(sound_desc)
        st.caption(sound_hint)
        st.warning("ğŸ“± **æ‰‹æ©Ÿç”¨æˆ¶æ³¨æ„ï¼š** è‹¥ç„¡æ³•éŒ„éŸ³ï¼Œè«‹é»æ“Š LINE/FB å³ä¸Šè§’é¸å–®ï¼Œé¸æ“‡**ã€Œåœ¨ç€è¦½å™¨é–‹å•Ÿã€**ä¸¦å…è¨±éº¥å…‹é¢¨æ¬Šé™ã€‚")
        rec = st.audio_input("éŒ„éŸ³ (2-3ç§’)", key="s1_rec")

        can_save = rec and member_nick
        if can_save:
            if st.button("ğŸ’¾ ä¸Šå‚³ä¸¦è©¦è½", type="primary"):
                with st.spinner("è™•ç†ä¸­..."):
                    audio_bytes = rec.read()
                    p = database.load_persona(supabase, target_role)
                    content = p['content'] if p else "å°šæœªè¨­å®šäººè¨­"
                    database.save_persona_summary(supabase, target_role, content, member_nickname=member_nick)

                    if target_role == "friend":
                        audio.upload_audio_file(supabase, target_role, audio_bytes, "opening")
                    else:
                        audio.upload_audio_file(supabase, target_role, audio_bytes, "nickname")
                        audio.upload_audio_file(supabase, target_role, audio_bytes, "opening")
                    
                    rec.seek(0)
                    audio.train_voice_sample(rec.read())
                    database.update_profile_stats(supabase, user_id, xp_delta=1, log_reason="å®ŒæˆStep1")
                    
                    ai_wav = audio.generate_speech(ai_demo_text, tier)
                    final = audio.merge_audio_clips(audio_bytes, ai_wav)
                    st.audio(final, format="audio/mp3")
                    st.success("è¨­å®šå·²å„²å­˜ï¼ç²å¾— 1 é»å…±é³´å€¼")

        if st.button("ä¸‹ä¸€æ­¥ â†’"): st.session_state.step = 2; st.rerun()

    # ==========================================
    # STEP 2-4: æƒ…ç·’è…³æœ¬ (éš¨æ©ŸåŠ‡æœ¬ç‰ˆ)
    # ==========================================
    elif st.session_state.step in [2, 3, 4]:
        
        cfg = SCRIPTS_POOL[st.session_state.step]
        
        # å–å‡ºç•¶å‰æ–‡ç«  (ä½¿ç”¨ Modulo å¾ªç’°)
        current_text = cfg["contents"][st.session_state.script_idx % len(cfg["contents"])]
        
        st.subheader(f"STEP {st.session_state.step}: {cfg['title']}")
        st.markdown(f'<div class="script-box">{current_text}</div>', unsafe_allow_html=True)
        
        # --- å„²å­˜ç‹€æ…‹å›æ”¾ ---
        saved_audio = audio.get_audio_bytes(supabase, target_role, cfg["file"])
        if saved_audio:
            st.caption("ğŸµ ç›®å‰å·²å„²å­˜çš„æ¨£æœ¬ (è‹¥ä¸æ»¿æ„å¯é‡æ–°éŒ„è£½è¦†è“‹)ï¼š")
            st.audio(saved_audio, format="audio/mp3")

        # --- æ§åˆ¶å€ (è­¦èª + æ›æ–‡ç« æŒ‰éˆ•) ---
        c_warn, c_change = st.columns([7, 3], vertical_alignment="bottom")
        with c_warn:
            st.warning("ğŸ“± æ‰‹æ©Ÿè‹¥ç„¡æ³•éŒ„éŸ³ï¼Œè«‹ç”¨ Chrome/Safari é–‹å•Ÿã€‚")
        with c_change:
            # æ›æ–‡ç« æŒ‰éˆ•
            if st.button("ğŸ”„ æ›æ–‡ç«  (å¢åŠ ç›¸ä¼¼åº¦)", help="é»æ“Šåˆ‡æ›ä¸‹ä¸€ç¯‡éš¨æ©Ÿæ–‡ç« ï¼Œå¤šéŒ„å¹¾ç¨®ç‰ˆæœ¬å¯è®“ AI æ›´è°æ˜"):
                st.session_state.script_idx += 1
                st.rerun()

        rec = st.audio_input("è«‹æœ—è®€ä¸Šæ–¹æ–‡å­—", key=f"step{st.session_state.step}_rec_{st.session_state.script_idx}")
        
        if rec:
            if st.button("ğŸ’¾ ä¸Šå‚³ä¸¦è¦†è“‹èˆŠæª”"):
                with st.spinner("è¨“ç·´ Voice ID ä¸¦å­˜æª”ä¸­..."):
                    ab = rec.read()
                    # 1. å­˜å…¥ Supabase (è¦†è“‹èˆŠæª”)
                    audio.upload_audio_file(supabase, target_role, ab, cfg["file"])
                    
                    # 2. è¨“ç·´ AI (ç–ŠåŠ è¨“ç·´)
                    rec.seek(0)
                    audio.train_voice_sample(rec.read())
                    
                    database.update_profile_stats(supabase, user_id, xp_delta=1, log_reason=f"Step{st.session_state.step}")
                    st.success("å·²æ›´æ–°è¨“ç·´æ¨£æœ¬ï¼ (+1 XP)")
                    st.rerun() 
        
        col_prev, col_next = st.columns(2)
        with col_prev: 
            if st.button("â† ä¸Šä¸€æ­¥"): st.session_state.step -= 1; st.rerun()
        with col_next: 
            btn_txt = "ä¸‹ä¸€æ­¥ â†’" if st.session_state.step < 4 else "å®Œæˆè¨“ç·´ â†’"
            if st.button(btn_txt): st.session_state.step += 1; st.rerun()

    # ==========================================
    # STEP 5: å®Œæˆèˆ‡å¼•å°
    # ==========================================
    elif st.session_state.step == 5:
        st.balloons()
        role_zh = ROLE_DISPLAY_NAMES.get(target_role, target_role)
        st.markdown(f"""
        <div style='text-align:center; padding:30px; background-color:#262730; border:1px solid #4CAF50; border-radius:15px;'>
            <h2 style='color:#4CAF50;'>ğŸ‰ æ­å–œï¼{role_zh} çš„åˆç´šèªæ°£æ¨¡å‹å·²å®Œæˆã€‚</h2>
            <p>æ‚¨ç¾åœ¨å¯ä»¥é»æ“Šä¸Šæ–¹çš„ <b>ã€ŒğŸ ç”Ÿæˆé‚€è«‹å¡ã€</b> åˆ†äº«çµ¦å°æ–¹äº†ã€‚</p>
        </div>
        """, unsafe_allow_html=True)
        if st.button("â† è¿”å› Step 1 é‡éŒ„"): st.session_state.step = 1; st.rerun()
